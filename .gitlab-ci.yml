stages:
  - build

variables:
  USER_IMAGE_NAME: $REGISTRY_USERNAME/istio-user-service
  USER_IMAGE_TAG: latest
  AUTH_IMAGE_NAME: $REGISTRY_USERNAME/istio-auth-service
  AUTH_IMAGE_TAG: latest

build-image-user-service:
  stage: build
  image: docker:20.10.21
  services:
    - docker:20.10.21-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DEPOT_TOKEN: $DEPOT_TOKEN
  before_script:
    - apk add --no-cache curl
    - curl https://depot.dev/install-cli.sh | DEPOT_INSTALL_DIR=/usr/local/bin sh
    - docker login -u $REGISTRY_USERNAME -p $REGISTRY_PASSWORD
  script:
    - cd user-service
    - depot build --project td1mkrfjz6 -t $USER_IMAGE_NAME:$USER_IMAGE_TAG . --push

build-image-auth-service:
  stage: build
  image: docker:20.10.21
  services:
    - docker:20.10.21-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DEPOT_TOKEN: $DEPOT_TOKEN
  before_script:
    - apk add --no-cache curl
    - curl https://depot.dev/install-cli.sh | DEPOT_INSTALL_DIR=/usr/local/bin sh
    - docker login -u $REGISTRY_USERNAME -p $REGISTRY_PASSWORD
  script:
    - cd user-service
    - depot build --project td1mkrfjz6 -t $AUTH_IMAGE_NAME:$AUTH_IMAGE_TAG . --push